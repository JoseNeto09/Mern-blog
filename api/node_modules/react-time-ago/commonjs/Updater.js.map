{"version":3,"file":"Updater.js","names":["instances","add","instance","wasIdle","length","start","stop","remove","forceUpdate","updateInstance","tick","now","Date","nextUpdateTime","scheduleNextTick","scheduledTick","requestAnimationFrame","cancel","_updateInstance","getNextValue","value","setValue","i","findTargetIndex","splice","indexOf","binarySearch"],"sources":["../source/Updater.js"],"sourcesContent":["// Manages the updates of all `<ReactTimeAgo/>` elements on a page.\r\n\r\n// The reasons for going with `requestAnimationFrame()`:\r\n// * `requestAnimationFrame` won't be called when a tab is in background.\r\n// * Chrome has bugs when handling `setTimeout()`: https://www.npmjs.com/package/request-animation-frame-timeout\r\n\r\n// `requestAnimationFrame()` polyfill for old browsers.\r\nimport requestAnimationFrame from 'raf'\r\n\r\nimport binarySearch from './helpers/binarySearch.js'\r\n\r\nexport default {\r\n\tinstances: [],\r\n\tadd(instance) {\r\n\t\tconst wasIdle = this.instances.length === 0\r\n\t\tadd(this.instances, instance)\r\n\t\tif (wasIdle) {\r\n\t\t\tthis.start()\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tstop: () => {\r\n\t\t\t\tremove(this.instances, instance)\r\n\t\t\t\tif (this.instances.length === 0) {\r\n\t\t\t\t\tthis.stop()\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tforceUpdate: () => {\r\n\t\t\t\tupdateInstance(instance, this.instances)\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\ttick() {\r\n\t\tconst now = Date.now()\r\n\t\twhile (true) {\r\n\t\t\tconst instance = this.instances[0]\r\n\t\t\tif (now >= instance.nextUpdateTime) {\r\n\t\t\t\tupdateInstance(instance, this.instances)\r\n\t\t\t} else {\r\n\t\t\t\tbreak\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tscheduleNextTick() {\r\n\t\tthis.scheduledTick = requestAnimationFrame(() => {\r\n\t\t\tthis.tick()\r\n\t\t\tthis.scheduleNextTick()\r\n\t\t})\r\n\t},\r\n\tstart() {\r\n\t\tthis.scheduleNextTick()\r\n\t},\r\n\tstop() {\r\n\t\trequestAnimationFrame.cancel(this.scheduledTick)\r\n\t}\r\n}\r\n\r\nfunction _updateInstance(instance) {\r\n\tconst [value, nextUpdateTime] = instance.getNextValue()\r\n\tinstance.setValue(value)\r\n\tinstance.nextUpdateTime = nextUpdateTime\r\n}\r\n\r\nfunction updateInstance(instance, instances) {\r\n\t_updateInstance(instance)\r\n\tremove(instances, instance)\r\n\tadd(instances, instance)\r\n}\r\n\r\nfunction add(instances, instance) {\r\n\tconst i = findTargetIndex(instances, instance)\r\n\tinstances.splice(i, 0, instance)\r\n}\r\n\r\nfunction remove(instances, instance) {\r\n\tconst i = instances.indexOf(instance)\r\n\tinstances.splice(i, 1)\t\r\n}\r\n\r\nfunction findTargetIndex(instances, instance) {\r\n\tconst { nextUpdateTime } = instance\r\n\treturn binarySearch(instances, (instance) => {\r\n\t\tif (instance.nextUpdateTime === nextUpdateTime) {\r\n\t\t\treturn 0\r\n\t\t} else if (instance.nextUpdateTime > nextUpdateTime) {\r\n\t\t\treturn 1\r\n\t\t} else {\r\n\t\t\treturn -1\r\n\t\t}\r\n\t})\r\n}"],"mappings":"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"}